<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheetah Capture - è§†é¢‘æˆªå¸§å’ŒéŸ³è½¨æ£€æµ‹å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 12px 20px;
            background: white;
            border: 2px dashed #667eea;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            color: #667eea;
            font-weight: 500;
        }

        .file-input-label:hover {
            background: #f0f4ff;
            border-color: #5568d3;
        }

        .file-input-label.has-file {
            border-style: solid;
            background: #f0f4ff;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #js_button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #js_button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #js_audio_check {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        #js_audio_check:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .info-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 50px;
        }

        .info-panel:empty::before {
            content: 'ç­‰å¾…æ“ä½œ...';
            color: #999;
        }

        .supported-formats {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 12px;
            color: #856404;
        }

        .result-container {
            margin-top: 20px;
        }

        .result-container h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-grid img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .image-grid img:hover {
            transform: scale(1.05);
        }

        .success-text {
            color: #28a745;
            font-weight: 500;
        }

        .error-text {
            color: #dc3545;
            font-weight: 500;
        }

        .warning-text {
            color: #ffc107;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¬ Cheetah Capture</h1>
        <p class="subtitle">è§†é¢‘æˆªå¸§å’ŒéŸ³è½¨æ£€æµ‹å·¥å…·</p>

        <div class="control-panel">
            <div class="form-group">
                <label for="js_file">é€‰æ‹©è§†é¢‘æ–‡ä»¶</label>
                <div class="file-input-wrapper">
                    <input 
                        id="js_file" 
                        type="file" 
                        accept="video/mp4,video/quicktime,video/x-msvideo,video/webm,video/x-matroska,video/x-flv,video/x-ms-wmv,.mp4,.mov,.avi,.webm,.mkv,.flv,.wmv,.m4v,.3gp,.mpg,.mpeg" 
                        multiple>
                    <label for="js_file" class="file-input-label" id="js_file_label">
                        ğŸ“ ç‚¹å‡»é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
                    </label>
                </div>
                <div class="supported-formats">
                    <strong>æ”¯æŒçš„æ ¼å¼ï¼š</strong>MP4, MOV, AVI, WebM, MKV, FLV, WMV, M4V, 3GP, MPG, MPEG
                </div>
            </div>

            <div class="form-group">
                <label for="js_time">æˆªå–å¸§æ•°</label>
                <input id="js_time" type="number" value="5" min="1" max="50" placeholder="è¾“å…¥è¦æˆªå–çš„å¸§æ•°ï¼ˆ1-50ï¼‰">
            </div>

            <div class="button-group">
                <button id="js_button" disabled>ğŸï¸ æå–è§†é¢‘å¸§</button>
                <button id="js_audio_check" disabled>ğŸ”Š æ£€æµ‹éŸ³è½¨</button>
            </div>
        </div>

        <div class="info-panel" id="js_info"></div>

        <div class="info-panel" id="js_audio_info"></div>

        <div class="result-container" id="js_result_container" style="display: none;">
            <h3>æˆªå–ç»“æœ</h3>
            <div class="image-grid" id="js_result"></div>
        </div>
    </div>

    <script src="../dist/index.js" type="application/javascript"></script>
    <script>
        // æ™ºèƒ½è·¯å¾„é…ç½® - å…¼å®¹ä¸åŒçš„å¯åŠ¨æ–¹å¼
        const currentPath = window.location.pathname;
        const isInDemo = currentPath.includes('/demo/');
        
        // å¦‚æœåœ¨ demo ç›®å½•ä¸‹ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼›å¦åˆ™ä½¿ç”¨ç»å¯¹è·¯å¾„
        // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢æµè§ˆå™¨ç¼“å­˜
        const timestamp = Date.now();
        const workerPath = (isInDemo ? '../dist/capture.worker.js' : '/dist/capture.worker.js') + '?v=' + timestamp;
        const wasmPath = (isInDemo ? '../dist/capture.worker.wasm' : '/dist/capture.worker.wasm') + '?v=' + timestamp;
        
        // DOM å…ƒç´ 
        const button = document.querySelector('#js_button');
        const audioCheckButton = document.querySelector('#js_audio_check');
        const resultContainer = document.querySelector('#js_result');
        const resultContainerWrapper = document.querySelector('#js_result_container');
        const fileInput = document.querySelector('#js_file');
        const fileLabel = document.querySelector('#js_file_label');
        const infoContainer = document.querySelector('#js_info');
        const audioInfoContainer = document.querySelector('#js_audio_info');
        const timeInput = document.querySelector('#js_time');

        // åˆå§‹åŒ– Cheetah Capture - æ·»åŠ é”™è¯¯å¤„ç†
        console.log('å¼€å§‹åˆå§‹åŒ– Cheetah Capture...');
        console.log('å½“å‰é¡µé¢è·¯å¾„:', currentPath);
        console.log('æ˜¯å¦åœ¨ demo ç›®å½•:', isInDemo);
        console.log('Worker è·¯å¾„:', workerPath);
        console.log('WASM è·¯å¾„:', wasmPath);
        console.log('å®Œæ•´ Worker URL:', new URL(workerPath, window.location.href).href);
        console.log('å®Œæ•´ WASM URL:', new URL(wasmPath, window.location.href).href);
        
        // æ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€
        infoContainer.innerHTML = 'â³ æ­£åœ¨åˆå§‹åŒ– WASM æ¨¡å—ï¼Œè¯·ç¨å€™...';
        
        let captureInstance = null;
        let isReady = false;
        
        const capturePro = cheetahCapture.initCapture({
            workerPath,
            wasmPath,
        }).then(instance => {
            console.log('âœ… Cheetah Capture åˆå§‹åŒ–æˆåŠŸ');
            captureInstance = instance;
            isReady = true;
            infoContainer.innerHTML = '<span class="success-text">âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨</span>';
            return instance;
        }).catch(error => {
            console.error('âŒ Cheetah Capture åˆå§‹åŒ–å¤±è´¥:', error);
            infoContainer.innerHTML = '<span class="error-text">âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</span>';
            // ç¦ç”¨æŒ‰é’®
            button.disabled = true;
            audioCheckButton.disabled = true;
            throw error;
        });

        // æ–‡ä»¶é€‰æ‹©ç›‘å¬
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                // æ›´æ–°æ–‡ä»¶æ ‡ç­¾æ˜¾ç¤º
                const fileNames = Array.from(files).map(f => f.name).join(', ');
                fileLabel.innerHTML = `âœ… å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ï¼š<br><small>${fileNames.length > 100 ? fileNames.substring(0, 100) + '...' : fileNames}</small>`;
                fileLabel.classList.add('has-file');
                
                // å¯ç”¨æŒ‰é’®
                button.disabled = false;
                audioCheckButton.disabled = false;
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                infoContainer.innerHTML = '';
                audioInfoContainer.innerHTML = '';
            } else {
                fileLabel.innerHTML = 'ğŸ“ ç‚¹å‡»é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰';
                fileLabel.classList.remove('has-file');
                button.disabled = true;
                audioCheckButton.disabled = true;
            }
        });

        // éŸ³è½¨æ£€æµ‹åŠŸèƒ½
        audioCheckButton.addEventListener('click', async () => {
            console.log('ğŸ”Š ç‚¹å‡»éŸ³è½¨æ£€æµ‹æŒ‰é’®');
            
            // æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
            if (!isReady) {
                audioInfoContainer.innerHTML = '<span class="warning-text">âš ï¸ WASM æ¨¡å—æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å€™...</span>';
                console.log('âš ï¸ WASM æœªå°±ç»ª');
                return;
            }
            
            const files = fileInput.files;
            if (files.length === 0) {
                audioInfoContainer.innerHTML = '<span class="warning-text">âš ï¸ è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶</span>';
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            audioCheckButton.disabled = true;
            button.disabled = true;
            
            audioInfoContainer.innerHTML = 'ğŸ” æ­£åœ¨æ£€æµ‹éŸ³è½¨...';
            const file = files[0];
            console.log('å‡†å¤‡æ£€æµ‹æ–‡ä»¶:', file.name);
            
            let res;
            try {
                res = await capturePro;
                console.log('âœ… è·å–åˆ° capture å®ä¾‹:', res);
            } catch (error) {
                console.error('âŒ è·å– capture å®ä¾‹å¤±è´¥:', error);
                audioInfoContainer.innerHTML = '<span class="error-text">âŒ åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</span>';
                audioCheckButton.disabled = false;
                button.disabled = false;
                return;
            }
            
            try {
                // å…ˆæŒ‚è½½æ–‡ä»¶
                console.log('å¼€å§‹æŒ‚è½½æ–‡ä»¶...');
                await new Promise((resolve, reject) => {
                    // è®¾ç½®è¶…æ—¶
                    const timeout = setTimeout(() => {
                        reject(new Error('æŒ‚è½½æ–‡ä»¶è¶…æ—¶ï¼ˆ30ç§’ï¼‰'));
                    }, 30000);
                    
                    res.mountFile({
                        file,
                        onSuccess: () => {
                            clearTimeout(timeout);
                            console.log('âœ… æŒ‚è½½æ–‡ä»¶æˆåŠŸï¼Œå¼€å§‹æ£€æµ‹éŸ³è½¨');
                            // æŒ‚è½½æˆåŠŸåæ£€æµ‹éŸ³è½¨
                            try {
                                res.hasAudioTrack({
                                onSuccess: (hasAudio) => {
                                    console.log('âœ… éŸ³è½¨æ£€æµ‹ç»“æœ:', hasAudio);
                                    audioInfoContainer.innerHTML = hasAudio 
                                        ? '<span class="success-text">âœ… è¯¥è§†é¢‘åŒ…å«éŸ³è½¨</span>' 
                                        : '<span class="warning-text">âš ï¸ è¯¥è§†é¢‘ä¸åŒ…å«éŸ³è½¨ï¼ˆé™éŸ³è§†é¢‘ï¼‰</span>';
                                    
                                    // æ£€æµ‹å®Œæˆåé‡Šæ”¾èµ„æº
                                    res.free({
                                        onSuccess: () => {
                                            console.log('âœ… èµ„æºé‡Šæ”¾æˆåŠŸ');
                                            resolve();
                                        }
                                    });
                                },
                                onError: (error) => {
                                    clearTimeout(timeout);
                                    console.error('âŒ æ£€æµ‹éŸ³è½¨å¤±è´¥:', error);
                                    audioInfoContainer.innerHTML = '<span class="error-text">âŒ æ£€æµ‹éŸ³è½¨å¤±è´¥: ' + error + '</span>';
                                    reject(error);
                                }
                            });
                            } catch (error) {
                                console.error('âŒ æ£€æµ‹éŸ³è½¨å‡ºé”™:', error);
                                audioInfoContainer.innerHTML = '<span class="error-text">âŒ æ£€æµ‹éŸ³è½¨å¤±è´¥: ' + error + '</span>';
                                reject(error);
                            }
                        },
                        onError: (error) => {
                            clearTimeout(timeout);
                            console.error('âŒ æŒ‚è½½æ–‡ä»¶å¤±è´¥:', error);
                            audioInfoContainer.innerHTML = '<span class="error-text">âŒ æŒ‚è½½æ–‡ä»¶å¤±è´¥: ' + error + '</span>';
                            reject(error);
                        }
                    });
                });
            } catch (error) {
                console.error('âŒ éŸ³è½¨æ£€æµ‹å‡ºé”™:', error);
                audioInfoContainer.innerHTML = '<span class="error-text">âŒ ' + error.message + '</span>';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                audioCheckButton.disabled = false;
                button.disabled = false;
            }
        });

        button.addEventListener('click', async () => {
            console.log('ğŸï¸ ç‚¹å‡»æå–è§†é¢‘å¸§æŒ‰é’®');
            
            // æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
            if (!isReady) {
                infoContainer.innerHTML = '<span class="warning-text">âš ï¸ WASM æ¨¡å—æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å€™...</span>';
                console.log('âš ï¸ WASM æœªå°±ç»ª');
                return;
            }
            
            const files = fileInput.files;
            if (files.length === 0) {
                infoContainer.innerHTML = '<span class="warning-text">âš ï¸ è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶</span>';
                return;
            }
            
            const captureTimes = parseInt(timeInput.value, 10);
            if (isNaN(captureTimes) || captureTimes < 1 || captureTimes > 50) {
                infoContainer.innerHTML = '<span class="error-text">âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å¸§æ•°ï¼ˆ1-50ï¼‰</span>';
                return;
            }
            
            console.log(`å‡†å¤‡æå– ${files.length} ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶ ${captureTimes} å¸§`);
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            button.disabled = true;
            audioCheckButton.disabled = true;
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            resultContainer.innerHTML = '';
            resultContainerWrapper.style.display = 'block';
            audioInfoContainer.innerHTML = '';
            
            let res;
            try {
                res = await capturePro;
                console.log('âœ… è·å–åˆ° capture å®ä¾‹:', res);
            } catch (error) {
                console.error('âŒ è·å– capture å®ä¾‹å¤±è´¥:', error);
                infoContainer.innerHTML = '<span class="error-text">âŒ åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</span>';
                button.disabled = false;
                audioCheckButton.disabled = false;
                return;
            }
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const startTime = Date.now();
                
                console.log(`ğŸ“Š å¼€å§‹å¤„ç†æ–‡ä»¶ ${i + 1}/${files.length}:`, file.name);
                infoContainer.innerHTML = `ğŸ“Š æ­£åœ¨å¤„ç†æ–‡ä»¶ ${i + 1}/${files.length}: <strong>${file.name}</strong><br>â³ æŒ‚è½½æ–‡ä»¶ä¸­...`;
                
                try {
                    await new Promise((resolve, reject) => {
                        // è®¾ç½®è¶…æ—¶
                        const timeout = setTimeout(() => {
                            reject(new Error('å¤„ç†è¶…æ—¶ï¼ˆ60ç§’ï¼‰'));
                        }, 60000);
                        
                        // ä½¿ç”¨æ”¹é€ åçš„ mountFile APIï¼Œåªä¼  file å‚æ•°
                        console.log('å¼€å§‹æŒ‚è½½æ–‡ä»¶...');
                        res.mountFile({
                            file, // path å‚æ•°å·²ç»å˜æˆå¯é€‰çš„ï¼Œé»˜è®¤ä¸º '/working'
                            onSuccess: () => {
                                clearTimeout(timeout);
                                console.log('âœ… æŒ‚è½½æ–‡ä»¶æˆåŠŸï¼Œå¼€å§‹æˆªå¸§');
                                infoContainer.innerHTML = `ğŸ“Š æ­£åœ¨å¤„ç†æ–‡ä»¶ ${i + 1}/${files.length}: <strong>${file.name}</strong><br>ğŸ¬ æ­£åœ¨æå–è§†é¢‘å¸§...`;
                                res.getMetadata({
                                    info: 'minor_version',
                                    onSuccess: data => {
                                        if (data) {
                                           console.log('=====>meta change', data)
                                        }
                                    },
                                });
                                let frameCount = 0;
                                res.capture({
                                    info: captureTimes,
                                    onChange: (list = {}, now = {}, info = {}) => {
                                        console.log(`âœ… æ”¶åˆ°ç¬¬ ${frameCount + 1} å¸§`);
                                        const { width, height, duration } = info;
                                        frameCount++;
                                        
                                        const img = document.createElement('img');
                                        img.src = now.url;
                                        img.title = `å¸§ ${frameCount}/${captureTimes} - ${file.name}`;
                                        resultContainer.appendChild(img);

                                        infoContainer.innerHTML = `
                                            ğŸ“Š æ­£åœ¨å¤„ç†æ–‡ä»¶ ${i + 1}/${files.length}: <strong>${file.name}</strong><br>
                                            â±ï¸ è€—æ—¶ï¼š${Date.now() - startTime}ms<br>
                                            ğŸ“ å°ºå¯¸ï¼š${width} Ã— ${height}<br>
                                            â²ï¸ æ—¶é•¿ï¼š${duration.toFixed(2)}s<br>
                                            ğŸï¸ è¿›åº¦ï¼š${frameCount}/${captureTimes} å¸§
                                        `;
                                    },
                                    onSuccess: (list) => {
                                        console.log(`âœ… æ–‡ä»¶ ${i + 1} æˆªå¸§å®Œæˆï¼Œå…± ${frameCount} å¸§`);
                                        infoContainer.innerHTML = `
                                            <span class="success-text">âœ… æ–‡ä»¶ ${i + 1}/${files.length} å¤„ç†å®Œæˆ: ${file.name}</span><br>
                                            â±ï¸ æ€»è€—æ—¶ï¼š${Date.now() - startTime}ms<br>
                                            ğŸï¸ å·²æå–ï¼š${frameCount} å¸§
                                        `;
                                        
                                        res.free({
                                            onSuccess: () => {
                                                console.log('âœ… èµ„æºé‡Šæ”¾æˆåŠŸ');
                                                resolve();
                                            }
                                        });
                                    },
                                    onError: (error) => {
                                        clearTimeout(timeout);
                                        console.error('âŒ æˆªå¸§å¤±è´¥:', error);
                                        infoContainer.innerHTML = `<span class="error-text">âŒ æˆªå¸§å¤±è´¥: ${error}</span>`;
                                        reject(error);
                                    }
                                });
                            },
                            onError: (error) => {
                                clearTimeout(timeout);
                                console.error('âŒ æŒ‚è½½æ–‡ä»¶å¤±è´¥:', error);
                                infoContainer.innerHTML = `<span class="error-text">âŒ æŒ‚è½½æ–‡ä»¶å¤±è´¥: ${error}</span>`;
                                reject(error);
                            }
                        });
                    });
                } catch (error) {
                    console.error('âŒ å¤„ç†æ–‡ä»¶å‡ºé”™:', error);
                    infoContainer.innerHTML = `<span class="error-text">âŒ å¤„ç†æ–‡ä»¶å¤±è´¥: ${error.message}</span>`;
                    break;
                }
            }
            
            // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆåæ¢å¤æŒ‰é’®
            button.disabled = false;
            audioCheckButton.disabled = false;
            
            if (files.length > 1) {
                infoContainer.innerHTML = `<span class="success-text">ğŸ‰ å…¨éƒ¨å®Œæˆï¼å…±å¤„ç† ${files.length} ä¸ªæ–‡ä»¶</span>`;
            }
        });
    </script>
</body>

</html>